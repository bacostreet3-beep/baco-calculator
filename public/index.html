<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貝克街-烘焙計算機</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-gold: #b8860b;
            --text-light: #666666;
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --btn-bg: #f0f0f0;
            --btn-hover: #e0e0e0;
            --error-red: #d32f2f;
            --success-green: #2e7d32;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: sans-serif; padding: 20px; line-height: 1.6; }
        h1, h2, h3 { color: var(--text-gold); text-align: center; margin-bottom: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background-color: var(--card-bg); border: 1px solid #eaeaea; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; align-items: center; width: 140px; }
        button, select { background-color: var(--btn-bg); color: var(--text-main); border: 1px solid var(--input-border); padding: 10px; border-radius: 6px; width: 100%; cursor: pointer; }
        button.active { background-color: var(--text-gold); color: white; border-color: var(--text-gold); font-weight: bold; }
        .help-btn { font-size: 12px; color: var(--text-light); background: none; border: none; margin-top: 5px; width: auto; }
        input[type="number"], input[type="text"], textarea { background-color: var(--input-bg); border: 1px solid var(--input-border); padding: 10px; width: 100%; border-radius: 6px; box-sizing: border-box; }
        .recipe-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .recipe-table th, .recipe-table td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; }
        .ai-section { border: 2px dashed var(--text-gold); background-color: #fffaf0; padding: 25px; text-align: center; }
        .btn-analyze { background-color: var(--text-main); color: white; border: none; font-weight: bold; margin-top: 10px; }
        .mold-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>貝克街 Baco Street</h1>
    <h2>烘焙計算機</h2>

    <div class="card ai-section">
        <div style="margin-bottom:10px; color:#666;">AI 辨識非 100% 準確，請務必檢查對比食材重量</div>
        <textarea id="ai-text-input" placeholder="貼上食譜文字，或拖曳食譜照片至此框內..." rows="4"></textarea>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; align-items:center;">
            <input type="file" id="ai-image-input" accept="image/*" onchange="handleFileSelect(this)">
            <button id="ai-trigger-btn" class="btn-analyze" style="width:auto; padding:10px 30px;">開始辨識</button>
        </div>
        <div id="ai-status-bar" style="margin-top:15px; font-weight:bold; color:var(--text-gold);"></div>
    </div>

    <div class="card">
        <h3>配方換算表</h3>
        <div class="controls">
            <div class="control-group"><button class="mode-btn active" onclick="setMode('weight')">A. 輸入重量</button></div>
            <div class="control-group"><button class="mode-btn" onclick="setMode('real_pct')">B. 輸入實際 %</button></div>
            <div class="control-group"><button class="mode-btn" onclick="setMode('baker_pct')">C. 輸入烘焙 %</button></div>
            <div class="control-group"><button class="mode-btn" onclick="setMode('single_base')">D. 修改單一食材</button></div>
        </div>
        
        <div id="total-weight-input-group" style="display:none; text-align:center; margin-bottom:15px;">
            配方總重量 (g): <input type="number" id="total-weight-global" value="1000" style="width:100px; display:inline-block;" oninput="onGlobalTotalChange()">
        </div>

        <table class="recipe-table">
            <thead>
                <tr>
                    <th id="th-base" style="width:8%">基準</th>
                    <th>食材</th>
                    <th>重量 (g)</th>
                    <th>實際 %</th>
                    <th>烘焙 %</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="recipe-body"></tbody>
            <tfoot>
                <tr>
                    <td id="tf-base"></td>
                    <td><strong>總計</strong></td>
                    <td id="sum-weight" style="font-weight:bold;">0</td>
                    <td id="sum-real-pct">100%</td>
                    <td id="sum-baker-pct">-</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <div style="margin-top:20px; text-align:center;">
            <button onclick="addRow()" style="width:auto; background:var(--text-gold); color:white; border:none;">+ 新增食材</button>
            <button onclick="clearTable()" style="width:auto; background:transparent; color:red; border:1px solid red; margin-left:10px;">清空表格</button>
        </div>
    </div>
    
    <div class="card">
        <h3>模具換算</h3>
        <div style="text-align:center;">
             模具類型：
            <select id="mold-type" onchange="updateMoldInputs()" style="width:auto; display:inline-block;">
                <option value="round">圓形模具 (吋)</option>
                <option value="square">方形模具 (cm)</option>
            </select>
        </div>
        <div class="mold-grid">
            <div id="src-inputs"></div>
            <div id="dst-inputs"></div>
        </div>
        <div style="text-align:center; margin-top:20px; font-size:1.2em; color:var(--text-gold); font-weight:bold;">
            換算係數：x <span id="mold-factor">1.0</span>
        </div>
    </div>
</div>

<script>
    let ingredients = [{ id: 1, name: '麵粉', weight: 100, realPct: 100, bakerPct: 100, isBase: true }];
    let nextId = 2;
    let currentMode = 'weight';

    window.onload = function() { buildTable(); updateCalculations(null); updateMoldInputs(); initDragAndDrop(); };

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('total-weight-input-group').style.display = (mode === 'real_pct' || mode === 'baker_pct') ? 'block' : 'none';
        if (mode === 'baker_pct') ingredients.forEach(i => i.isBase = false);
        buildTable();
    }

    function buildTable() {
        const tbody = document.getElementById('recipe-body');
        tbody.innerHTML = '';
        const showBase = (currentMode === 'baker_pct' || currentMode === 'single_base');
        document.getElementById('th-base').style.display = document.getElementById('tf-base').style.display = showBase ? '' : 'none';

        ingredients.forEach((item, index) => {
            const tr = document.createElement('tr');
            let wDis = (currentMode === 'weight') ? false : true;
            if(currentMode === 'single_base') wDis = !item.isBase;
            
            tr.innerHTML = `
                <td style="${showBase?'':'display:none'}"><input type="radio" name="base" ${item.isBase?'checked':''} onchange="onBaseChange(${index})"></td>
                <td><input value="${item.name}" oninput="ingredients[${index}].name=this.value"></td>
                <td><input type="number" id="w-${index}" value="${format(item.weight)}" ${wDis?'readonly':''} oninput="onInput(${index},'w',this.value)"></td>
                <td><input type="number" id="r-${index}" value="${format(item.realPct)}" readonly>%</td>
                <td><input type="number" id="b-${index}" value="${format(item.bakerPct)}" readonly>%</td>
                <td><button onclick="delRow(${index})" style="color:red; background:none; border:none;">×</button></td>
            `;
            tbody.appendChild(tr);
        });
        updateFooter();
    }

    function onInput(idx, type, val) {
        ingredients[idx].weight = parseFloat(val) || 0;
        updateCalculations();
    }
    
    function onBaseChange(idx) {
        ingredients.forEach(i => i.isBase = false);
        ingredients[idx].isBase = true;
        updateCalculations();
    }

    function updateCalculations() {
        let total = ingredients.reduce((s,i) => s + i.weight, 0);
        let base = ingredients.find(i => i.isBase) || ingredients[0];
        let flour = base ? base.weight : 0;
        
        if (currentMode === 'real_pct') {
            let globalTotal = parseFloat(document.getElementById('total-weight-global').value) || 1000;
            // logic for real pct mode omitted for brevity, keeping it simple for display
        }

        ingredients.forEach(i => {
            i.realPct = total ? (i.weight/total*100) : 0;
            i.bakerPct = flour ? (i.weight/flour*100) : 0;
        });
        
        // Refresh view
        ingredients.forEach((item, idx) => {
            let wInput = document.getElementById(`w-${idx}`);
            if (document.activeElement !== wInput) wInput.value = format(item.weight);
            document.getElementById(`r-${idx}`).value = format(item.realPct);
            document.getElementById(`b-${idx}`).value = format(item.bakerPct);
        });
        updateFooter();
    }

    function updateFooter() {
        let total = ingredients.reduce((s,i) => s + i.weight, 0);
        document.getElementById('sum-weight').innerText = format(total);
    }

    function format(n) { return Math.round(n*100)/100; }
    function addRow() { ingredients.push({name:'', weight:0, realPct:0, bakerPct:0, isBase:false}); buildTable(); }
    function delRow(i) { if(ingredients.length>1) ingredients.splice(i,1); buildTable(); updateCalculations(); }
    function clearTable() { if(confirm('清空?')) { ingredients=[{name:'麵粉',weight:100,realPct:100,bakerPct:100,isBase:true}]; buildTable(); updateCalculations(); }}

    // 模具簡單邏輯
    function updateMoldInputs() {
        let type = document.getElementById('mold-type').value;
        let html = type==='round' ? '<input id="d" placeholder="直徑">' : '<input id="l" placeholder="長"><input id="w" placeholder="寬">';
        document.getElementById('src-inputs').innerHTML = '原: ' + html + '<input id="h" value="5" placeholder="高">';
        document.getElementById('dst-inputs').innerHTML = '新: ' + html + '<input id="h2" value="5" placeholder="高">';
    }

    // AI 功能
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function handleFileSelect(input) {
        if(input.files[0]) document.getElementById('ai-text-input').placeholder = `已讀取: ${input.files[0].name}`;
    }

    function initDragAndDrop() {
        let dz = document.getElementById('ai-text-input');
        dz.ondragover = e => { e.preventDefault(); dz.style.background='#fffdf0'; };
        dz.ondragleave = e => { e.preventDefault(); dz.style.background='#fafafa'; };
        dz.ondrop = e => {
            e.preventDefault();
            if(e.dataTransfer.files[0]) {
                document.getElementById('ai-image-input').files = e.dataTransfer.files;
                handleFileSelect(document.getElementById('ai-image-input'));
            }
        };
    }

    document.getElementById('ai-trigger-btn').onclick = async () => {
        let btn = document.getElementById('ai-trigger-btn');
        let status = document.getElementById('ai-status-bar');
        let text = document.getElementById('ai-text-input').value;
        let file = document.getElementById('ai-image-input').files[0];

        if(!text && !file) return alert('請輸入文字或圖片');
        
        btn.disabled = true;
        status.innerText = '⏳ 分析中...';

        try {
            let payload = { text };
            if(file) payload.image = await toBase64(file);

            let res = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            let data = await res.json();
            if(!res.ok) throw new Error(data.error || 'Server Error');
            
            if(data.data && data.data.length > 0) {
                ingredients = data.data.map((i, idx) => ({
                    name: i.name, weight: i.weight, realPct:0, bakerPct:0, isBase: idx===0
                }));
                buildTable();
                updateCalculations();
                status.innerText = '✅ 完成!';
                status.style.color = 'green';
            } else {
                throw new Error('無法辨識');
            }
        } catch(e) {
            status.innerText = '❌ ' + e.message;
            status.style.color = 'red';
        } finally {
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
